# status-067: サロゲートモデル追加検証 + 簡略化全結合GNN性能テスト + 梁スポット導入レビュー

[← README](../../README.md) | [← status-index](status-index.md) | [← roadmap](../roadmap.md)

**日付**: 2026-02-26
**作業者**: Claude Code
**テスト数**: 1577（+23: 追加検証 9 + 全結合GNN 14）

## 概要

status-066のTODO消化として以下を実施：
1. **サロゲートモデルの追加検証テスト**（汎化性・ロバスト性・物理的整合性・特徴量アブレーション・エネルギー収支）
2. **簡略化全結合GNN（FullyConnectedThermalGNN）の実装と性能比較**
3. **梁実装へのサロゲートモデル スポット導入レビュー**

## 1. サロゲートモデル追加検証（9テスト）

### テスト一覧

| テストクラス | テスト名 | 内容 |
|------------|---------|------|
| TestGeneralization | test_unseen_seed_data | 別シードデータで R²>0 確認 |
| TestGeneralization | test_train_val_gap | val/train 損失比 < 10（過学習検出） |
| TestRobustness | test_single_source_prediction | 発熱体1個で有限値出力 |
| TestRobustness | test_max_sources_prediction | 発熱体5個で有限値出力 |
| TestPhysicalConsistency | test_predicted_delta_t_nonnegative | 予測ΔT≧0 の割合 > 80% |
| TestPhysicalConsistency | test_temperature_monotonicity_near_source | ポテンシャル–ΔT 相関 > 0.3 |
| TestFeatureAblation | test_heat_potential_improves_r2 | ポテンシャル特徴量の効果定量化 |
| TestEnergyBalance | test_fem_energy_balance | FEM発熱量 > 0 |
| TestEnergyBalance | test_fem_max_temp_at_source | 最高温度が発熱体近傍 |

### 検証結果の知見

- **汎化性**: 50サンプル学習・80エポックの小規模モデルでも未知データに R²>0 の相関が残る
- **過学習**: train/val 損失比が10未満 → 小規模データでも過度な過学習は発生していない
- **物理整合性**: ΔT≧0の割合が80%以上 → 発熱のみの問題で温度下降予測は少ない
- **特徴量重要性**: 発熱ポテンシャル Σ1/(r²+ε) がΔTと正相関（r>0.3）→ GNNの受容野制約を補完

## 2. 簡略化全結合GNN（14テスト）

### アーキテクチャ

```
FullyConnectedThermalGNN:
  ノード特徴量 (6D) → Encoder MLP (6→H→H)
  → FCEdgeConvLayer × L 層 (mean集約, edge_dim=3)
  → Decoder MLP (H→H→1) → ΔT
```

**メッシュGNNとの違い**:
- エッジ: メッシュ辺接続（O(N)） → **全ノード間の全結合（O(N²)）**
- 集約: add → **mean**（エッジ数増に対応した正規化）
- 受容野: L層で ~L ホップ → **1層で全域カバー**

### 性能比較結果

**条件**: 5×5メッシュ（36ノード）、70サンプル（train 50, val 10, test 10）、80エポック

| モデル | R² | MAE (°C) | パラメータ数 | エッジ数 |
|--------|-----|----------|-----------|---------|
| **メッシュGNN (4層)** | **0.925** | **0.123** | 28,097 | 120 (双方向) |
| 全結合GNN (4層) | 0.642 | 0.308 | 28,097 | 1,260 |
| 全結合GNN (2層) | 0.257 | 0.455 | 28,097 | 1,260 |

### 考察

1. **メッシュ帰納バイアスの優位性**: メッシュGNNは隣接ノード間の局所相互作用（熱伝導の物理）をエッジ構造に直接エンコードしている。全結合GNNはこの構造を持たず、全ペアの関係を学習する必要がある。
2. **エッジ数の爆発**: 36ノードでも全結合エッジは1,260本（メッシュの10倍以上）。学習がメッセージの「ノイズ」に埋もれる。
3. **mean集約の効果**: add集約だと全結合でメッセージ合計が巨大化するため、mean集約を使用。それでも遠方ノードの無関連情報が精度を下げる。
4. **2層 vs 4層**: 全結合GNNは2層でも全域カバー可能だが、R²=0.257と低い。層数を増やしても0.642止まり → 受容野以外のボトルネックが存在。

**結論**: 固定正則メッシュ上の定常問題では、メッシュの帰納バイアスが全結合グラフのフレキシビリティを大きく上回る。全結合GNNは「メッシュ構造が不明」「不規則メッシュ」「メッシュ解像度が変わる」ケースでのみ有効と考えられる。

## 3. 梁実装へのサロゲートモデル スポット導入レビュー

### 効率的と考えられるポイント

#### A. 接触検出のプリスクリーニング（推奨度: ★★★★☆）
- **現状**: Broadphase (AABB格子) + Narrowphase (最近点計算) で O(N²) → O(N log N)
- **提案**: GNNで「接触の可能性が高いペア」を事前予測し、Narrowphaseの候補を絞る
- **利点**: 接触ペア数が少ない段階的アクティベーションとの親和性が高い。Broadphaseの高速化になる
- **入力/出力**: 梁セグメント座標 → 接触確率マップ（二値分類）
- **データ**: 既存の撚線テストから自動生成可能

#### B. 初期ペナルティ剛性の推定（推奨度: ★★★★☆）
- **現状**: `auto_beam_penalty_stiffness()` で EI/L³ ベースの経験式
- **提案**: 断面パラメータ + メッシュ + 接触幾何 → 最適 k_pen を推定するMLモデル
- **利点**: 収束速度への影響が大きく、チューニング工数を大幅削減
- **注意**: 学習データ＝「収束したケースの最適k_pen」を自動収集する仕組みが必要

#### C. Newton-Raphsonの初期推定（推奨度: ★★★☆☆）
- **現状**: 前ステップ解を初期値としてNR反復
- **提案**: GNNで次ステップの変位を予測し、NRの初期値を改善
- **利点**: NR反復回数の削減（特に大変形・接触の不連続点付近）
- **制約**: 推論コスト < 節約されるNR反復コストである必要がある

#### D. 弧長法のステップ幅制御（推奨度: ★★★☆☆）
- **現状**: 固定 or 適応的ステップ幅
- **提案**: 現在の力残差パターンからリミットポイント接近を予測
- **利点**: 分岐点近傍でのステップ幅自動調整

### 非効率と考えられるポイント

#### X. 構成則の代替（推奨度: ★☆☆☆☆）
- **理由**: 1D弾塑性の return mapping は O(1) で十分高速。GNNの推論コスト（バッチ化しても数ms）が上回る
- **例外**: 3D von Mises + 大規模メッシュでは Newton 反復を含むため代替の余地あり。ただし Phase 4.3 は凍結中

#### Y. 要素剛性行列の計算代替（推奨度: ★☆☆☆☆）
- **理由**: 梁要素の剛性行列は解析解（閉形式）で得られるため、GNNによる近似は精度・速度ともに劣る
- **例外**: Cosserat rod のSRI（選択低減積分）は数値積分を伴うが、積分点数が少ないため代替メリットなし

#### Z. メッシュ生成の自動化（推奨度: ★★☆☆☆）
- **理由**: 撚線メッシュファクトリ（make_twisted_wire_mesh）は幾何学的に正確な解析式ベース。GNNによるメッシュ生成は不正確で検証困難
- **ただし**: 断面形状の自動最適化（被膜厚の最適化等）は最適化ループの中にGNNを置く形で有効

### 総合評価

| 導入候補 | 推奨度 | 実装難度 | 期待効果 | 優先度 |
|---------|--------|---------|---------|--------|
| 接触プリスクリーニング | ★★★★ | 中 | 大規模問題の高速化 | **高** |
| k_pen最適推定 | ★★★★ | 中 | 収束安定化 | **高** |
| NR初期推定 | ★★★ | 高 | NR反復削減 | 中 |
| 弧長法ステップ制御 | ★★★ | 高 | 分岐追跡改善 | 中 |
| 断面最適化 | ★★ | 低 | 設計支援 | 低 |
| 構成則代替 | ★ | 中 | なし（既に高速） | 不要 |
| 要素剛性代替 | ★ | 中 | なし（解析解あり） | 不要 |

### 結論

サロゲートモデルの梁実装へのスポット導入は **「計算のボトルネックが組合せ的 or 反復的なところ」** に限定するのが効率的。具体的には **接触検出** と **ペナルティ剛性推定** が最優先候補。構成則・要素剛性など解析的に求まる部分への導入は非効率。

今回のGNN検証で得た知見として、**メッシュの帰納バイアス**が正則メッシュ上では全結合GNNを大差で上回る点は、梁メッシュへのGNN適用でも同様に作用すると予想される。梁の接続構造（線形トポロジー）をエッジに反映したGNNを設計すべき。

## テスト追加（+23テスト）

| ファイル | テスト数 | 内容 |
|---------|---------|------|
| test_surrogate_validation.py | 9 | 汎化性、ロバスト性、物理整合性、アブレーション、エネルギー収支 |
| test_gnn_fc.py | 14 | FC構造テスト、変換テスト、学習テスト、メッシュ比較 |

## ファイル変更

### 新規
- `xkep_cae/thermal/gnn_fc.py` — 全結合GNNサロゲートモデル
- `tests/thermal/test_surrogate_validation.py` — 追加検証テスト
- `tests/thermal/test_gnn_fc.py` — 全結合GNNテスト
- `docs/status/status-067.md`

### 変更
- `docs/status/status-index.md` — status-067追加
- `docs/roadmap.md` — サロゲート検証項目更新
- `README.md` — 現在状態更新

## TODO

- [ ] Physics-Informed ロス（L_phys = ||K·T_pred - Q||²）の導入検証
- [ ] 不規則メッシュでの全結合GNN vs メッシュGNN再検証（全結合の優位性が出るか）
- [ ] 接触プリスクリーニング用GNNの設計（梁セグメント座標 → 接触確率マップ）
- [ ] k_pen最適推定MLモデルの設計（断面パラメータ + メッシュ → 最適k_pen）

## 確認事項・懸念

- 全結合GNNの精度が低い結果は小規模テスト（36ノード, 70サンプル）によるものであり、大規模メッシュでは結果が異なる可能性がある。ただし、メッシュの帰納バイアスの優位性は理論的にも予想される結果。
- 梁実装へのサロゲート導入は、まず接触検出のプリスクリーニングから開始し、効果を測定した上で他の候補に展開するのが安全。

---
